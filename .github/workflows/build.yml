name: Build and Release

on:
  # 仅允许手动触发，禁用自动构建
  workflow_dispatch:
    inputs:
      prerelease:
        description: '是否标记为预发布版本'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      PYTHONUTF8: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # =============== 严格校验 VERSION 格式 ===============
      - name: Validate VERSION format
        shell: powershell
        run: |
          $versionLine = Get-Content "VERSION" -TotalCount 1 -ErrorAction SilentlyContinue
          if (-not $versionLine) {
            Write-Error "❌ VERSION file is missing or empty!"
            exit 1
          }
          $version = $versionLine.Trim()
          if ($version -eq "") {
            Write-Error "❌ VERSION file is empty!"
            exit 1
          }

          Write-Host "VERSION content: '$version'"

          $stablePattern = '^\d+\.\d+\.\d+$'
          $betaPattern   = '^\d+\.\d+\.\d+_Beta$'
          $devPattern    = '^\d+\.\d+\.\d+_Dev$'

          $isMasterPush = "${{ github.ref }}" -eq "refs/heads/master"
          $isBetaPush = "${{ github.ref }}" -eq "refs/heads/Beta"

          if ($isMasterPush) {
            # master 分支必须是稳定版
            if ($version -notmatch $stablePattern) {
              Write-Error "❌ On 'master', VERSION must be 'x.x.x' (e.g., '1.2.3'). Found: '$version'"
              exit 1
            }
          } elseif ($isBetaPush) {
            # Beta 分支必须带有 _Beta 后缀
            if ($version -notmatch $betaPattern) {
              Write-Error "❌ On 'Beta' branch, VERSION must be 'x.x.x_Beta'. Found: '$version'"
              exit 1
            }
          } else {
            # 手动触发：允许三种格式
            if (-not ($version -match $stablePattern -or $version -match $betaPattern -or $version -match $devPattern)) {
              Write-Error "❌ VERSION must be 'x.x.x', 'x.x.x_Beta', or 'x.x.x_Dev'. Found: '$version'"
              exit 1
            }
          }

      # =============== 构建步骤 ===============
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip

      - name: Configure CMake for Tray App
        run: |
          cmake -S tray -B tray/build -DCMAKE_BUILD_TYPE=Release

      - name: Build Tray App
        run: |
          cmake --build tray/build --config Release

      - name: Create Portable Python Environment
        shell: powershell
        run: |
          $pyVersion = "3.11.9"
          $pyUrl = "https://www.python.org/ftp/python/$pyVersion/python-$pyVersion-embed-amd64.zip"
          Invoke-WebRequest -Uri $pyUrl -OutFile "python_embed.zip"
          Expand-Archive -Path "python_embed.zip" -DestinationPath ".venv"
          
          cd .venv
          $pthFile = Get-ChildItem -Filter "python*._pth" | Select-Object -First 1
          $content = Get-Content $pthFile.Name
          $content = $content -replace '#import site', 'import site'
          $content | Set-Content $pthFile.Name
          
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          .\python.exe get-pip.py --no-warn-script-location
          .\python.exe -m pip install -r ..\requirements.txt --no-warn-script-location
          
          Remove-Item "get-pip.py", "..\python_embed.zip"
          cd ..
          Write-Host "✅ Portable Python ready."

      - name: Setup Inno Setup Chinese Support
        shell: powershell
        run: |
          if (-not (Test-Path "ChineseSimplified.isl")) {
            $url = "https://raw.githubusercontent.com/kira-96/Inno-Setup-Chinese-Simplified-Translation/master/ChineseSimplified.isl"
            Invoke-WebRequest -Uri $url -OutFile "ChineseSimplified.isl"
          }
          if ((Get-Content "ChineseSimplified.isl" -Raw) -notmatch "\[LangOptions\]") {
            throw "Invalid ChineseSimplified.isl"
          }

      - name: Build Full Installer
        shell: powershell
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" Capture_Push_Setup.iss

      - name: Build Lite Installer
        shell: powershell
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" Capture_Push_Lite_Setup.iss

      # =============== 生成校验和文件 ===============
      - name: Generate Checksums
        shell: powershell
        run: |
          $fullInstaller = "Output/Capture_Push_Setup.exe"
          $liteInstaller = "Output/Capture_Push_Lite_Setup.exe"
          
          if (Test-Path $fullInstaller) {
            $fullHash = (Get-FileHash -Path $fullInstaller -Algorithm SHA256).Hash
            "$fullHash  $(Split-Path $fullInstaller -Leaf)" | Out-File -FilePath "Capture_Push_Setup.exe.sha256" -Encoding ASCII
            Write-Host "Full installer SHA256: $fullHash"
            echo "FULL_INSTALLER_SHA256=$fullHash" >> $env:GITHUB_ENV
          }
          
          if (Test-Path $liteInstaller) {
            $liteHash = (Get-FileHash -Path $liteInstaller -Algorithm SHA256).Hash
            "$liteHash  $(Split-Path $liteInstaller -Leaf)" | Out-File -FilePath "Capture_Push_Lite_Setup.exe.sha256" -Encoding ASCII
            Write-Host "Lite installer SHA256: $liteHash"
            echo "LITE_INSTALLER_SHA256=$liteHash" >> $env:GITHUB_ENV
          }

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Installers-${{ github.run_number }}
          path: |
            Output/Capture_Push_Setup.exe
            Output/Capture_Push_Lite_Setup.exe
            *.sha256
          retention-days: 3

      # =============== 提取版本并准备发布 ===============
      - name: Extract Version
        shell: powershell
        run: |
          $version = (Get-Content "VERSION" | Select-Object -First 1).Trim()
          Add-Content -Path $env:GITHUB_ENV -Value "APP_VERSION=$version"
          $tagVersion = "v$version" -replace "_", "-"
          Add-Content -Path $env:GITHUB_ENV -Value "TAG_VERSION=$tagVersion"

      # =============== 条件性发布 Release ===============
      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: ${{ !contains(env.APP_VERSION, '_Dev') && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/Beta' || github.event_name == 'workflow_dispatch') }}
        with:
          files: |
            Output/Capture_Push_Setup.exe
            Output/Capture_Push_Lite_Setup.exe
          tag_name: ${{ env.TAG_VERSION }}
          name: Release ${{ env.APP_VERSION }}
          body: |
            Version: ${{ env.APP_VERSION }}
            Build: ${{ github.run_number }}
            Branch: ${{ github.ref_name }}
            
            ## Packages
            - **Full**: Includes Python runtime (~200-500 MB)
            - **Lite**: Program-only update (~2-10 MB)
            
            ## Integrity Checks
            - **Full SHA256**: `${{ env.FULL_INSTALLER_SHA256 }}`
            - **Lite SHA256**: `${{ env.LITE_INSTALLER_SHA256 }}`
            
            You can verify the integrity of the downloaded files using these hashes.
          draft: false
          # 如果是 Beta 分支，或者版本号包含 _Beta，或者手动勾选了 prerelease，则标记为预发布
          prerelease: ${{ github.ref == 'refs/heads/Beta' || contains(env.APP_VERSION, '_Beta') || github.event.inputs.prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}