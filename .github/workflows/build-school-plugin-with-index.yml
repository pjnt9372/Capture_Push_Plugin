name: Build and Release School Plugin with Index Update

on:
  workflow_dispatch:
    inputs:
      school_code:
        description: 'School code to build (e.g., 10546)'
        required: true
        # 移除默认值以强制用户输入
        # default: '10546'
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        # 移除默认值以强制用户输入
        # default: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4 # 使用更新的版本以获得更好的安全性
    
    - name: Set up Python
      uses: actions/setup-python@v5 # 使用更新的版本以获得更好的安全性
      with:
        python-version: '3.9'
        
    - name: Get school code and version from inputs
      id: vars
      run: |
        # 修正变量赋值逻辑，使用 GITHUB_EVENT_INPUTS
        SCHOOL_CODE="${{ github.event.inputs.school_code }}"
        VERSION="${{ github.event.inputs.version }}"
        
        # 添加基本验证
        if [[ -z "$SCHOOL_CODE" || -z "$VERSION" ]]; then
          echo "Error: Both school_code and version must be provided."
          exit 1
        fi

        echo "SCHOOL_CODE=$SCHOOL_CODE" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Using school code: $SCHOOL_CODE and version: $VERSION"
        
    - name: Prepare plugin directory
      run: |
        mkdir -p plugin_build/${{ env.SCHOOL_CODE }}
        # Copy actual plugin files if they exist, otherwise create sample structure
        if [ -d "school/${{ env.SCHOOL_CODE }}" ]; then
          echo "Found existing plugin structure for ${{ env.SCHOOL_CODE }}, copying..."
          cp -r school/${{ env.SCHOOL_CODE }}/* plugin_build/${{ env.SCHOOL_CODE }}/ || { echo "Failed to copy existing plugin."; exit 1; }
        else
          echo "Creating sample plugin structure for ${{ env.SCHOOL_CODE }}"
          mkdir -p plugin_build/${{ env.SCHOOL_CODE }}
          # Create sample plugin files if needed
          cat << 'EOF' > plugin_build/${{ env.SCHOOL_CODE }}/getCourseGrades.py
# -*- coding: utf-8 -*-
"""
成绩获取模块 - 示例插件
用于从教务系统获取学生成绩信息
"""


def fetch_grades(username, password, force_update=False):
    """
    获取学生成绩
    
    Args:
        username: 用户名
        password: 密码
        force_update: 是否强制更新
    
    Returns:
        成绩数据字典
    """
    # 这里是示例实现，实际插件应该实现真实的获取逻辑
    print(f"模拟获取 {username} 的成绩信息...")
    
    # 模拟成绩数据
    grades_data = {
        "student_info": {
            "name": "张三",
            "student_id": username,
            "college": "示例学院",
            "major": "示例专业",
            "grade": "2021级"
        },
        "grades": [
            {
                "course_name": "高等数学",
                "credit": 4.0,
                "score": "85",
                "grade_point": 3.5,
                "semester": "2021-2022-1",
                "exam_type": "考试"
            }
        ],
        "gpa": 3.5
    }
    
    return grades_data


def parse_grades(raw_data):
    """
    解析原始成绩数据
    
    Args:
        raw_data: 原始数据
    
    Returns:
        解析后的成绩数据
    """
    # 在真实插件中，这里会解析从教务系统获取的原始HTML/JSON数据
    # 这里只是返回模拟的数据
    return raw_data
EOF

          cat << 'EOF' > plugin_build/${{ env.SCHOOL_CODE }}/getCourseSchedule.py
# -*- coding: utf-8 -*-
"""
课表获取模块 - 示例插件
用于从教务系统获取学生课表信息
"""

def fetch_course_schedule(username, password, force_update=False):
    """
    获取学生课表
    
    Args:
        username: 用户名
        password: 密码
        force_update: 是否强制更新
    
    Returns:
        课表数据字典
    """
    # 这里是示例实现，实际插件应该实现真实的获取逻辑
    print(f"模拟获取 {username} 的课表信息...")
    
    # 模拟课表数据
    schedule_data = {
        "student_info": {
            "name": "张三",
            "student_id": username,
            "college": "示例学院",
            "major": "示例专业",
            "grade": "2021级"
        },
        "schedule": [
            {
                "course_name": "高等数学",
                "teacher": "李教授",
                "classroom": "教学楼A101",
                "week_day": 1,  # 星期一
                "period_start": 1,
                "period_end": 2,
                "weeks": "1-16周",
                "semester": "2021-2022-1"
            }
        ]
    }
    
    return schedule_data


def parse_schedule(raw_data):
    """
    解析原始课表数据
    
    Args:
        raw_data: 原始数据
    
    Returns:
        解析后的课表数据
    """
    # 在真实插件中，这里会解析从教务系统获取的原始HTML/JSON数据
    # 这里只是返回模拟的数据
    return raw_data
EOF

          cat << EOF > plugin_build/${{ env.SCHOOL_CODE }}/__init__.py
# -*- coding: utf-8 -*-
"""
示例插件模块
"""


from .getCourseGrades import fetch_grades, parse_grades
from .getCourseSchedule import fetch_course_schedule, parse_schedule

SCHOOL_NAME = "示例院校"
SCHOOL_CODE = "${{ env.SCHOOL_CODE }}"
PLUGIN_VERSION = "${{ env.VERSION }}"

__all__ = ['fetch_grades', 'parse_grades', 'fetch_course_schedule', 'parse_schedule',
           'SCHOOL_NAME', 'SCHOOL_CODE', 'PLUGIN_VERSION']
EOF
        fi
        
    - name: Generate timestamp version
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        echo "Generated timestamp: $TIMESTAMP"
        
    - name: Create plugin ZIP without version
      run: |
        echo "Creating ZIP file..."
        cd plugin_build
        # Use 'zip -r' and redirect stderr to avoid noise
        zip -r "../school_${{ env.SCHOOL_CODE }}_plugin.zip" "./${{ env.SCHOOL_CODE }}" 2>/dev/null || { echo "ZIP creation failed"; exit 1; }
        cd ..
        echo "ZIP file created: school_${{ env.SCHOOL_CODE }}_plugin.zip"
        
    - name: Calculate SHA256
      id: sha256
      run: |
        echo "Calculating SHA256 checksum..."
        # Ensure the file exists before calculating checksum
        if [[ ! -f "school_${{ env.SCHOOL_CODE }}_plugin.zip" ]]; then
          echo "Error: Plugin ZIP file does not exist!"
          exit 1
        fi
        SHA256=$(sha256sum "school_${{ env.SCHOOL_CODE }}_plugin.zip" | cut -d' ' -f1)
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "Calculated SHA256: $SHA256"
        
    - name: Download existing plugins_index.json
      run: |
        echo "Downloading existing plugins_index.json..."
        # Use a temporary file to avoid overwriting on failure
        curl -fsSL "https://raw.githubusercontent.com/pjnt9372/Capture_Push_School_Plugins/main/plugins_index.json" -o "plugins_index_temp.json" || \
        { echo '{"plugins":[]}' > "plugins_index_temp.json"; echo "Download failed, using empty template."; }
        
        # Verify downloaded file integrity (optional but good practice)
        if ! jq empty "plugins_index_temp.json" 2>/dev/null; then
            echo "Warning: Downloaded file is invalid JSON, using empty template."
            echo '{"plugins":[]}' > "plugins_index_temp.json"
        fi
        mv "plugins_index_temp.json" "plugins_index.json"
        echo "Downloaded and validated plugins_index.json"
        
    - name: Update plugins_index.json
      run: |
        echo "Updating plugins_index.json..."
        # Install jq tool (for processing JSON)
        sudo apt-get update && sudo apt-get install -y jq

        # Validate JSON file integrity again after download step
        if ! jq empty plugins_index.json 2>/dev/null; then
          echo '{"plugins":[]}' > plugins_index.json
          echo "Fixed corrupted or missing plugins_index.json with empty object."
        fi

        # Create new plugin info object
        NEW_PLUGIN_INFO=$(jq -n \
          --arg code "${{ env.SCHOOL_CODE }}" \
          --arg name "示例院校" \
          --arg version "${{ env.VERSION }}" \
          --arg sha256 "${{ steps.sha256.outputs.sha256 }}" \
          --arg url "https://github.com/pjnt9372/Capture_Push_School_Plugins/releases/download/plugin%2Flatest/school_${{ env.SCHOOL_CODE }}_plugin.zip" \
          --arg contrib "$GITHUB_ACTOR" \
          --arg updated "$(date +%Y-%m-%d)" \
          '{school_code: $code, school_name: $name, plugin_version: $version, sha256: $sha256, download_url: $url, contributor: $contrib, last_updated: $updated}')

        echo "New plugin info to be added/updated:"
        echo $NEW_PLUGIN_INFO | jq .

        # Check if the plugin already exists in the index
        PLUGIN_EXISTS=$(cat plugins_index.json | jq -e --arg code "${{ env.SCHOOL_CODE }}" 'if type == "object" and .plugins then (.plugins[] | select(.school_code == $code) | .school_code) else empty end' 2>/dev/null)

        if [ -n "$PLUGIN_EXISTS" ]; then
          echo "Plugin ${{ env.SCHOOL_CODE }} already exists, updating its entry..."
          UPDATED_INDEX=$(cat plugins_index.json | jq --arg code "${{ env.SCHOOL_CODE }}" --argjson new_plugin "$NEW_PLUGIN_INFO" '(.plugins | map(if .school_code == $code then $new_plugin else . end))')
        else
          echo "Plugin ${{ env.SCHOOL_CODE }} does not exist, adding new entry..."
          UPDATED_INDEX=$(cat plugins_index.json | jq --argjson new_plugin "$NEW_PLUGIN_INFO" '.plugins |= . + [$new_plugin]')
        fi

        # Write the updated index back to the file
        echo "$UPDATED_INDEX" > plugins_index.json
        echo "Updated plugins_index.json contents:"
        cat plugins_index.json | jq .
        
    - name: Create Release
      uses: softprops/action-gh-release@v2 # Updated to a more recent version
      with:
        tag_name: plugin/latest
        name: Latest Plugin Release
        body: |
          School Plugin for code ${{ env.SCHOOL_CODE }}
          Timestamp: ${{ env.TIMESTAMP }}
          Version: ${{ env.VERSION }}
          Contributor: ${{ github.actor }}
          
          