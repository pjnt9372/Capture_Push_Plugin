name: Build and Release School Plugin with Index Update

on:
  workflow_dispatch:
    inputs:
      school_code:
        description: 'School code to build (e.g., 10546)'
        required: true
        default: '10546'
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Get school code and version
      id: vars
      run: |
        SCHOOL_CODE=${{ github.event.inputs.school_code || '10546' }}
        VERSION=${{ github.event.inputs.version || '1.0.0' }}
        echo "SCHOOL_CODE=$SCHOOL_CODE" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
    - name: Prepare plugin directory
      run: |
        # Copy the actual plugin from school/[SCHOOL_CODE] directory if it exists
        if [ -d "school/${{ env.SCHOOL_CODE }}" ]; then
          mkdir -p plugin_build/${{ env.SCHOOL_CODE }}
          cp -r school/${{ env.SCHOOL_CODE }}/* plugin_build/${{ env.SCHOOL_CODE }}/ || echo "Error copying plugin files"
        else
          echo "Error: Plugin directory school/${{ env.SCHOOL_CODE }} does not exist"
          exit 1
        fi
        
    - name: Generate timestamp version
      run: |
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        
    - name: Create plugin ZIP without version
      run: |
        cd plugin_build
        zip -r ../school_${{ env.SCHOOL_CODE }}_plugin.zip ./${{ env.SCHOOL_CODE }}
        cd ..
        
    - name: Calculate SHA256
      id: sha256
      run: |
        SHA256=$(sha256sum school_${{ env.SCHOOL_CODE }}_plugin.zip | cut -d' ' -f1)
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        
    - name: Download existing plugins_index.json
      run: |
        curl -o plugins_index.json https://raw.githubusercontent.com/pjnt9372/Capture_Push_School_Plugins/main/plugins_index.json || echo '{"plugins":[]}' > plugins_index.json
        
    - name: Update plugins_index.json
      run: |
        # Install jq tool (for processing JSON)
        sudo apt-get update && sudo apt-get install -y jq

        # Validate and fix potential JSON format issues
        if ! jq empty plugins_index.json 2>/dev/null; then
          echo '{"plugins":[]}' > plugins_index.json
        fi

        # Create new plugin info
        NEW_PLUGIN_INFO=$(jq -n --arg code "${{ env.SCHOOL_CODE }}" \
--arg name "院校名称" \
--arg version "${{ env.VERSION }}" \
--arg sha256 "${{ steps.sha256.outputs.sha256 }}" \
--arg url "https://github.com/pjnt9372/Capture_Push_School_Plugins/releases/download/plugin%2Flatest/school_${{ env.SCHOOL_CODE }}_plugin.zip" \
--arg contrib "$GITHUB_ACTOR" \
--arg updated "$(date +%Y-%m-%d)" \
'{school_code: $code, school_name: $name, plugin_version: $version, sha256: $sha256, download_url: $url, contributor: $contrib, last_updated: $updated}')

        # Check if the plugin already exists in the index
        INDEX_FILE_EXISTS=$(cat plugins_index.json | jq -e '.plugins | length' 2>/dev/null)
        if [ $? -eq 0 ]; then
          # Check if plugin exists
          EXISTS=$(cat plugins_index.json | jq -e --arg code "${{ env.SCHOOL_CODE }}" '.plugins[] | select(.school_code == $code) | .school_code' 2>/dev/null)
          
          if [ -n "$EXISTS" ]; then
            # Plugin exists, update entry
            cat plugins_index.json | jq --arg code "${{ env.SCHOOL_CODE }}" --argjson new_plugin "$NEW_PLUGIN_INFO" '(.plugins[] | select(.school_code == $code)) = $new_plugin' > temp_index.json
          else
            # Plugin doesn't exist, add new entry
            cat plugins_index.json | jq --argjson new_plugin "$NEW_PLUGIN_INFO" '.plugins |= . + [$new_plugin]' > temp_index.json
          fi
        else
          # Index file format incorrect, recreate
          echo '{"plugins":[$NEW_PLUGIN_INFO]}' > temp_index.json
        fi

        mv temp_index.json plugins_index.json
        cat plugins_index.json

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: plugin/latest
        name: Latest Plugin Release
        body: |
          School Plugin for code ${{ env.SCHOOL_CODE }}
          Timestamp: ${{ env.TIMESTAMP }}
          Contributor: ${{ github.actor }}
          
          ```json
          {
            "plugin_version": "${{ env.TIMESTAMP }}",
            "school_code": "${{ env.SCHOOL_CODE }}",
            "sha256": "${{ steps.sha256.outputs.sha256 }}",
            "contributor": "${{ github.actor }}",
            "min_app_version": "1.0.0"
          }
          ```
        files: |
          school_${{ env.SCHOOL_CODE }}_plugin.zip
        draft: false
        prerelease: false
        
    - name: Commit and push plugins_index.json
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git clone https://github.com/pjnt9372/Capture_Push_School_Plugins.git repo
        cd repo
        cp ../plugins_index.json .
        git add plugins_index.json
        git commit -m "Update plugins_index.json for ${{ env.SCHOOL_CODE }} v${{ env.VERSION }} [skip ci]" || echo "No changes to commit"
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/pjnt9372/Capture_Push_School_Plugins.git main || echo "Push failed"